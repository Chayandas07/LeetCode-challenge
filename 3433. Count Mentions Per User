#include <bits/stdc++.h>
using namespace std;

class Solution {
public:
    vector<int> countMentions(int numberOfUsers, vector<vector<string>>& events) {
        map<int, vector<vector<string>>> byTime;
        for (auto &ev : events) {
            int t = stoi(ev[1]);
            byTime[t].push_back(ev);
        }

        vector<int> mentions(numberOfUsers, 0);
        vector<bool> isOnline(numberOfUsers, true);
        vector<int> offlineUntil(numberOfUsers, 0);

        for (auto &entry : byTime) {
            int t = entry.first;
            auto &evs = entry.second;

            for (int i = 0; i < numberOfUsers; ++i) {
                if (!isOnline[i] && offlineUntil[i] <= t) {
                    isOnline[i] = true;
                    offlineUntil[i] = 0;
                }
            }

            for (auto &ev : evs) {
                if (ev[0] == "OFFLINE") {
                    int id = stoi(ev[2]);
                    isOnline[id] = false;
                    offlineUntil[id] = t + 60;
                }
            }

            for (auto &ev : evs) {
                if (ev[0] != "MESSAGE") continue;
                string mentionsStr = ev[2];
                string token;
                stringstream ss(mentionsStr);
                while (ss >> token) {
                    if (token == "ALL") {
                        for (int i = 0; i < numberOfUsers; ++i) mentions[i]++;
                    } else if (token == "HERE") {
                        for (int i = 0; i < numberOfUsers; ++i)
                            if (isOnline[i]) mentions[i]++;
                    } else if (token.rfind("id", 0) == 0) {
                        int id = stoi(token.substr(2));
                        if (0 <= id && id < numberOfUsers) mentions[id]++;
                    }
                }
            }
        }

        return mentions;
    }
};
